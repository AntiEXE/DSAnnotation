name: CodeCoverage

on:
  workflow_dispatch:
  # Optional: run on pull requests or nightly
  push: #for testing now
  pull_request:
     branches: [ main, develop ]

env:
  BUILD_TYPE: Debug
  BUILD_DIR: ${{ github.workspace }}/build
  LLVM_PROFILE_FILE: coverage.profraw

jobs:
  coverage:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-14 llvm-14 llvm-14-tools \
          libclang-14-dev cmake libgtest-dev

    - name: Configure CMake with Clang Coverage Flags
      run: |
        cmake -B ${{ env.BUILD_DIR }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DCMAKE_C_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_CXX_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
          -DLLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm \
          -DClang_DIR=/usr/lib/llvm-14/lib/cmake/clang

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${BUILD_TYPE}

    - name: Run Tests with Coverage
      working-directory: ${{ env.BUILD_DIR }}
      run: |
        LLVM_PROFILE_FILE="${LLVM_PROFILE_FILE}" ctest --verbose

    - name: Merge Coverage Data
      run: |
        llvm-profdata merge -sparse ${LLVM_PROFILE_FILE} -o coverage.profdata

    - name: Generate Coverage Report
      run: |
        llvm-cov report ${{ env.BUILD_DIR }}/ds_annotation \
          -instr-profile=coverage.profdata \
          --ignore-filename-regex='/usr/*'
        llvm-cov show ${{ env.BUILD_DIR }}/ds_annotation \
          -instr-profile=coverage.profdata \
          -format=html > coverage.html

    - name: Upload Coverage Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clang-coverage-report
        path: coverage.html

    # - name: Upload to Codecov
    #   uses: codecov/codecov-action@v4
    #   with:
    #     token: ${{ secrets.CODECOV_TOKEN }} # Add this secret in your repo settings
    #     files: coverage.profdata
    #     flags: clang
    #     name: codecov
    #     fail_ci_if_error: true
