name: BuildAndTestNix

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  linux_minimum_supported_build:
    name: Build and Test [ubuntu-22.04, GCC 11, LLVM 14]
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 14

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-11 g++-11 \
          llvm-${{env.LLVM_VERSION}}-dev \
          libclang-${{env.LLVM_VERSION}}-dev \
          clang-${{env.LLVM_VERSION}} \
          libgtest-dev \
          cmake ninja-build

    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_C_COMPILER=gcc-11 \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -GNinja
      env:
        LLVM_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/llvm
        Clang_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/clang

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

  linux_latest_clang_build:
    name: Build and Test [ubuntu-22.04, Clang 18, LLVM 18]
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 18

    steps:
    - uses: actions/checkout@v4

    - name: Install LLVM 18
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh ${{env.LLVM_VERSION}}

    - name: Install Other Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtest-dev \
          cmake ninja-build

    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_C_COMPILER=clang-${{env.LLVM_VERSION}} \
          -DCMAKE_CXX_COMPILER=clang++-${{env.LLVM_VERSION}} \
          -GNinja
      env:
        LLVM_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/llvm
        Clang_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/clang

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

  build_nix:
    name: Build and Test [${{matrix.os}}]
    runs-on: ${{matrix.os}}
    env:
      LLVM_VERSION: 14
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-13, macos-14]

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies (Ubuntu)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          llvm-${{env.LLVM_VERSION}}-dev \
          libclang-${{env.LLVM_VERSION}}-dev \
          clang-${{env.LLVM_VERSION}} \
          libgtest-dev \
          cmake ninja-build
      if: runner.os == 'Linux'

    - name: Install Dependencies (macOS)
      run: |
        brew install llvm@${{env.LLVM_VERSION}} googletest ninja
      if: runner.os == 'macOS'

    - name: Configure CMake (Ubuntu)
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -GNinja
      env:
        LLVM_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/llvm
        Clang_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/clang
      if: runner.os == 'Linux'

    - name: Configure CMake (macOS)
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -GNinja
      env:
        LLVM_DIR: $(brew --prefix llvm@${{env.LLVM_VERSION}})/lib/cmake/llvm
        Clang_DIR: $(brew --prefix llvm@${{env.LLVM_VERSION}})/lib/cmake/clang
      if: runner.os == 'macOS'

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

  build_with_coverage:
    name: Build and Test with Coverage [ubuntu-22.04, GCC 11, LLVM 14]
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 14

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-11 g++-11 \
          llvm-${{env.LLVM_VERSION}}-dev \
          libclang-${{env.LLVM_VERSION}}-dev \
          clang-${{env.LLVM_VERSION}} \
          libgtest-dev \
          cmake ninja-build \
          lcov

    - name: Configure CMake with Coverage
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-11 \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_C_FLAGS="--coverage" \
          -GNinja
      env:
        LLVM_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/llvm
        Clang_DIR: /usr/lib/llvm-${{env.LLVM_VERSION}}/lib/cmake/clang

    - name: Build
      run: cmake --build build --config Debug

    - name: Test
      run: ctest --test-dir build --output-on-failure --verbose

    - name: Generate Coverage Report
      run: |
        lcov --directory build --capture --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/nlohmann/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.info
        fail_ci_if_error: false
        verbose: true
