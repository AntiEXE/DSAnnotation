name: BuildAndTestNix

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  BUILD_DIR: ${{ github.workspace }}/build

jobs:
  linux_minimum_supported_gcc_build:
    name: Build and Test [ubuntu-22.04, Minimum GCC]
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Install Dependencies
      run: |
        sudo apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
        sudo apt-get update
        sudo apt-get -yq --no-install-suggests --no-install-recommends install \
          gcc-11 g++-11 valgrind \
          llvm-14 llvm-14-dev libclang-14-dev clang-14 \
          libgtest-dev cmake
      
    - name: Configure CMake
      run: |
        cmake -B ${{ env.BUILD_DIR }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=gcc-11 \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -DLLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm \
          -DClang_DIR=/usr/lib/llvm-14/lib/cmake/clang

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

    - name: Test
      working-directory: ${{ env.BUILD_DIR }}
      run: ctest --build-config ${{ env.BUILD_TYPE }} --verbose

  linux_clang_build:
    name: Build and Test [ubuntu-22.04, Supported Clang]
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get -yq --no-install-suggests --no-install-recommends install \
          valgrind lld \
          llvm-14 llvm-14-dev libclang-14-dev clang-14 \
          libgtest-dev cmake
      
    - name: Configure CMake
      run: |
        cmake -B ${{ env.BUILD_DIR }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DLLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm \
          -DClang_DIR=/usr/lib/llvm-14/lib/cmake/clang

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

    - name: Test
      working-directory: ${{ env.BUILD_DIR }}
      run: ctest --build-config ${{ env.BUILD_TYPE }} --verbose
  
  build_nix:
    name: Build and Test [${{ matrix.os }}]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-13, macos-14]
        include:
          - os: ubuntu-22.04
            llvm_version: "14"
            install_deps: |
              sudo apt-get update
              sudo apt-get install -y valgrind \
                llvm-14 llvm-14-dev libclang-14-dev clang-14 \
                libgtest-dev cmake
            cmake_extra_args: |
              -DLLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm \
              -DClang_DIR=/usr/lib/llvm-14/lib/cmake/clang
          - os: macos-13
            llvm_version: "14"
            install_deps: |
              brew install llvm@14 googletest cmake
            cmake_extra_args: |
              -DLLVM_DIR=$(brew --prefix llvm@14)/lib/cmake/llvm \
              -DClang_DIR=$(brew --prefix llvm@14)/lib/cmake/clang
          - os: macos-14
            llvm_version: "14"
            install_deps: |
              brew install llvm@14 googletest cmake
            cmake_extra_args: |
              -DLLVM_DIR=$(brew --prefix llvm@14)/lib/cmake/llvm \
              -DClang_DIR=$(brew --prefix llvm@14)/lib/cmake/clang

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Dependencies
      run: ${{ matrix.install_deps }}

    - name: Configure CMake
      run: |
        cmake -B ${{ env.BUILD_DIR }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          ${{ matrix.cmake_extra_args }}

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

    - name: Test
      working-directory: ${{ env.BUILD_DIR }}
      run: ctest --build-config ${{ env.BUILD_TYPE }} --verbose
