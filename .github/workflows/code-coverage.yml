name: CodeCoverage

on:
  workflow_dispatch:
  # Optional: run on pull requests or nightly
  push: #for testing now
  pull_request:
     branches: [ main, develop ]

env:
  BUILD_TYPE: Debug
  BUILD_DIR: ${{ github.workspace }}/build
  LLVM_PROFILE_FILE: coverage.profraw

jobs:
  coverage:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-14 llvm-14 llvm-14-tools \
          libclang-14-dev cmake libgtest-dev

    - name: Add LLVM tools to PATH
      run: echo "/usr/lib/llvm-14/bin" >> $GITHUB_PATH

    - name: Configure CMake with Clang Coverage Flags
      run: |
        cmake -B ${{ env.BUILD_DIR }} \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DCMAKE_C_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_CXX_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
          -DLLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm \
          -DClang_DIR=/usr/lib/llvm-14/lib/cmake/clang

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${BUILD_TYPE}

    - name: Run Tests with Coverage
      working-directory: ${{ env.BUILD_DIR }}
      run: |
        LLVM_PROFILE_FILE="${{ env.BUILD_DIR }}/coverage.profraw" ctest --verbose

    - name: Merge Coverage Data
      run: |
        llvm-profdata merge -sparse ${{ env.BUILD_DIR }}/coverage.profraw -o coverage.profdata

    - name: Generate Coverage Report
      run: |
        llvm-cov report ${{ env.BUILD_DIR }}/tests/dsannotation_tests \
            -instr-profile=coverage.profdata \
            --ignore-filename-regex='/usr/*|include/nlohmann/*'

        llvm-cov show ${{ env.BUILD_DIR }}/tests/dsannotation_tests \
            -instr-profile=coverage.profdata \
            --ignore-filename-regex='/usr/*|include/nlohmann/*' \
            -format=html > coverage.html

    - name: Upload Coverage Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clang-coverage-report
        path: coverage.html

    - name: Upload to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ${{ env.BUILD_DIR }}/coverage.profdata
        flags: clang
        name: clang-codecov
        fail_ci_if_error: true
