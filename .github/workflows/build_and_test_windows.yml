name: BuildAndTestWindows

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  BUILD_DIR: ${{github.workspace}}/build

jobs:
  build_win_msvc:
    name: Build and Test [windows-2022, MSVC]
    runs-on: windows-2022

    steps:
    - name: Initialization
      run: |
        git config --global core.autocrlf true

    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Dependencies and Verify LLVM
      run: |
        # Check existing LLVM installation (should be v20.1.8)
        echo "Checking existing LLVM installation..."
        choco list --local-only llvm
        
        # Verify LLVM is working
        if (Test-Path "C:\Program Files\LLVM\bin\clang.exe") {
            echo "✓ Using existing LLVM installation"
            & "C:\Program Files\LLVM\bin\clang.exe" --version
            echo "LLVM Path: C:\Program Files\LLVM"
        } else {
            echo "✗ LLVM not found, installing..."
            choco install llvm -y
        }
        
        # Install vcpkg for GTest
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg integrate install
        C:\vcpkg\vcpkg install gtest:x64-windows

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Verify LLVM Installation
      run: |
        echo "Checking LLVM installation..."
        if (Test-Path "C:\Program Files\LLVM\lib\cmake\llvm") {
            echo "✓ LLVM CMake files found"
            Get-ChildItem "C:\Program Files\LLVM\lib\cmake\llvm" | Select-Object Name
        } else {
            echo "✗ LLVM CMake files not found"
        }
        
        if (Test-Path "C:\Program Files\LLVM\lib\cmake\clang") {
            echo "✓ Clang CMake files found"
            Get-ChildItem "C:\Program Files\LLVM\lib\cmake\clang" | Select-Object Name
        } else {
            echo "✗ Clang CMake files not found"
        }

    - name: Configure CMake
      run: |
        # Configure without vcpkg first to avoid interference
        cmake -B ${{ env.BUILD_DIR }} `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DLLVM_DIR="C:/Program Files/LLVM/lib/cmake/llvm" `
          -DClang_DIR="C:/Program Files/LLVM/lib/cmake/clang" `
          -DCMAKE_PREFIX_PATH="C:/vcpkg/installed/x64-windows" `
          -G "Visual Studio 17 2022" -A x64

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_TYPE }}

    - name: Test
      working-directory: ${{ env.BUILD_DIR }}
      run: ctest --build-config ${{ env.BUILD_TYPE }} --verbose
